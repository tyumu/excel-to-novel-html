# Excel → 小説風HTML 自動変換ツール

[![Python 3.8+](https://img.shields.io/badge/python-3.8+-blue.svg)](https://www.python.org/downloads/)

Excelの会話データ（話者:セリフ形式）を縦書き小説風HTMLに自動変換するツールです。  
ArknightsStoryTextReaderでエクスポートした`.xlsx`ファイルに対応しています。

## 特徴

- **レスポンシブ縦書きデザイン** - スマホでの表示に最適化
- **AI変換対応** - 会話形式→小説形式への自動変換
- **ダイレクトモード** - AI不要で即座にHTML生成（`--no-ai`オプション）
- **分岐対応** - ゲームの選択肢と分岐ルートを視覚的に表示
- **画像対応** - イラスト・背景画像を自動挿入
- **バッチ処理** - 複数ファイルを一括変換
- **カスタマイズ可能** - キャラクター名の置換など柔軟に設定

## 使用例

### 入力（Excel）
```
| line | name | dialogue |
|------|------|----------|
| 1    | アーミヤ | ドクター、大丈夫ですか？ |
| 2    | ドクター | ……ここは？ |
```

### 出力（HTML - `--no-ai`モード）
```
【アーミヤ】
ドクター、大丈夫ですか？

【ドクター】
……ここは？
```

話者名が独立した行として表示され、読みやすい縦書きレイアウトになります。

## 必要要件

- Python 3.8以上
- 必要なパッケージ:
  ```bash
  pip install openpyxl
  ```

## ファイル構成

- **`simple_converter.py`** - メイン変換スクリプト（単一ファイル用）
- **`batch_converter.py`** - バッチ処理スクリプト（複数ファイル一括処理用）おすすめ
- **`config.py`** - 設定ファイル（キャラクター名、分岐設定）
- `ai_prompt.txt` - AIに送るプロンプトのテンプレート
- `check_excel.py` - Excelファイルの構造確認用
- `check_speakers.py` - 話者情報の確認用
- `check_decisions.py` - 分岐システムの確認用

## 使い方

### どちらの方法を使う？

| 方法 | 使う場合 | スクリプト |
|------|----------|-----------|
| **単一ファイル処理** | 1つのExcelファイルだけ変換したい | `simple_converter.py` |
| **バッチ処理** | 複数のExcelファイルを一括変換したい | `batch_converter.py` おすすめ |

---

## 方法A: バッチ処理（複数ファイル一括変換）おすすめ

複数のExcelファイルを一度に処理できます。続き物の章がある場合はこちらが便利です!

### 手順1: Excelファイルの準備

Excelファイルを **`main_数字_タイトル.xlsx`** の形式で用意してルート直下に置きます:

```
📁 プロジェクトフォルダ/
├── main_0_暗黒時代・上.xlsx  ← この形式!
├── main_1_暗黒時代・下.xlsx
├── main_2_新たな章.xlsx
└── batch_converter.py
```

### 手順2: データ抽出

```powershell
python batch_converter.py
```

**何が起こる？**
- すべての`main_*.xlsx`を自動検出
- 各ファイルから`ai_input_main_X_タイトル.txt`を生成
- 空の`novel_output_main_X_タイトル.txt`も作成

**出力例:**
```
✓ ai_input_main_0_暗黒時代・上.txt 生成完了
✓ 空の novel_output_main_0_暗黒時代・上.txt を作成
✓ ai_input_main_1_暗黒時代・下.txt 生成完了
✓ 空の novel_output_main_1_暗黒時代・下.txt を作成
```

### 手順3: AIで小説風に変換

**重要: ローカルAIの使用を推奨**

ストーリーデータを扱う都合上、**クラウドAI（ChatGPT、Claude等）への送信は避けてください**。  
以下のようなローカルAIの利用を強く推奨します:

- **LM Studio** - 使いやすいGUIでローカルLLMを実行 (推奨)
- **Ollama** - コマンドラインでローカルLLMを管理
- **text-generation-webui** - ブラウザベースのローカルAI
- **llama.cpp** - 軽量なローカル実行環境

これらのツールでLlama 3、Mistral、Gemmaなどのオープンソースモデルを使用できます。

**各ファイルごとに以下を実行:**

1. **`ai_prompt.txt`を開く** → 全文コピー
2. **ローカルAIに貼り付け** (LM Studio、Ollama など)
3. **その下に`output/ai_input_main_0_暗黒時代・上.txt`の内容**をすべて貼り付け
4. AIが小説風テキストを出力
5. **出力を`output/novel_output_main_0_暗黒時代・上.txt`に上書き保存**

※ 他のファイルも同様に処理

### 手順4: HTML生成

```powershell
python batch_converter.py
```

もう一度実行すると、内容がある`novel_output`ファイルだけHTMLに変換されます!

**出力:**
```
output/
├── main_0_暗黒時代・上.html
├── main_1_暗黒時代・下.html
└── main_2_新たな章.html
```

各HTMLファイルをブラウザで開いて楽しんでください!

**ポイント:**
- ファイル名: `main_0_暗黒時代・上.html` (番号付き)
- HTMLタイトル: `暗黒時代・上` (番号なし、読みやすい)

---

## 方法B: 単一ファイル処理

1つのExcelファイルだけ処理する場合はこちら。

### 手順1: データ抽出

```powershell
python simple_converter.py
```

`output/ai_input.txt` が生成されます。

### 手順2: AIで小説風に変換

**重要: ローカルAIの使用を推奨**

ゲームのストーリーデータには著作権があるため、**クラウドAI（ChatGPT、Claude等）への送信は避けてください**。  
以下のようなローカルAIの利用を強く推奨します:

- **LM Studio** - 使いやすいGUIでローカルLLMを実行 (推奨)
- **Ollama** - コマンドラインでローカルLLMを管理
- **text-generation-webui** - ブラウザベースのローカルAI
- **llama.cpp** - 軽量なローカル実行環境

これらのツールでLlama 3、Mistral、Gemmaなどのオープンソースモデルを使用できます。

1. `ai_prompt.txt` を開く → 全文コピー
2. ローカルAIに貼り付け
3. その下に `output/ai_input.txt` の内容を貼り付け
4. AIの出力を `output/novel_output.txt` に保存

### 手順3: HTML生成

```powershell
python simple_converter.py
```

`output/generated_novel.html` が生成されます!

---

## オプション設定

### AI変換をスキップ（直接HTML生成）NEW

AI変換をスキップして、Excelから抽出したテキストをそのまま縦書きHTMLにできます。

**単一ファイル:**
```powershell
python simple_converter.py --no-ai
```

**バッチ処理:**
```powershell
python batch_converter.py --no-ai
```

**こんな時に便利:**
- AI変換が不要な場合（すでに小説風の文章など）
- 【キャラ名】セリフ形式をそのままHTMLで見たい
- とりあえず縦書きプレビューを確認したい
- テスト・デバッグ用

**`--no-ai`モードの特徴:**
- **話者名が上に表示される** - `【キャラ名】`が独立した行として表示され、その下にセリフが続く形式
- **話者名は緑色の太字** - 一目で誰が話しているか分かる
- オマケなので所々表示がおかしい

**別名オプション:** `--direct`も同じ機能です

### ドクターの名前を変更（任意）

`config.py` を編集:

```python
DOCTOR_NAME = "ドクター"  # 好きな名前に変更
```

詳しくは `CONFIG_GUIDE.md` を参照。

---

---

## 抽出データの形式

```
============================================================
【シーン: level_main_00-01_beg】
============================================================

[背景]: https://example.com/bg.png
【ドーベルマン】くっ……
【ドーベルマン】どうなってるんだ、この状況は……！
【レユニオン構成員】――探せ! 家の中まで徹底的に調べるんだ！

【ドクターの選択肢】
  選択肢1: 状況を確認する
  選択肢2: 黙って様子を見る

【分岐: >Options_1】
【ドーベルマン】Dr.ドクター、判断を頼む！

[画像]: https://example.com/illustration.png
```

- **【キャラクター名】セリフ** - 話者情報付きセリフ
- **【ドクターの選択肢】** - プレイヤーの選択肢（15箇所）
- **【分岐: >Options_X】** - 選択による分岐ルート
- **[画像]: URL** - イラスト
- **[背景]: URL** - 背景画像
- **【シーン: 〜】** - シーン区切り
- **Dr.ドクター** - {@nickname}が置換された結果

## 💡 Tips

### データ量が多すぎる場合

大体、文字数が多いので、AIの制限に引っかかる場合:

**方法1: ファイルを分割**
```powershell
# ai_input.txt を手動で分割
# → ai_input_part1.txt, ai_input_part2.txt など
# それぞれ変換後、結合して novel_output.txt に保存
```

**方法2: シートごとに処理**
スクリプトを編集して、特定シートのみ抽出:
```python
# simple_converter.py の for sheet_name in wb.sheetnames: を
for sheet_name in ['0_welcome_to_guide', '2_guide_to_home']:  # 処理したいシートのみ
```

### カスタマイズ

`simple_converter.py` の以下の部分を編集:

```python
# HTMLのスタイルを変更
# <style>タグ内のCSS部分を編集

# ページ分割の調整
max_lines_per_page = 10  # この数字を変更
```

## 📊 抽出されるExcelデータ

- **シート数**: 14シート
- **総文字数**: 約36,650文字（話者情報込み）
- **分岐数**: 15箇所の選択肢分岐
- **置換**: {@nickname} → 設定したドクター名
- **シート例**:
  - `0_welcome_to_guide` (186行)
  - `2_guide_to_home`
  - `level_main_00-01_beg`
  - `level_main_00-01_end`（分岐あり）
  - など

## 🎨 生成されるHTML

- 縦書き表示（右から左）
- ページめくり対応（横スクロール）
- スマホ・タブレット対応
- 画像の自動挿入
- 見出しページの自動生成
- **数字の縦中横対応**（12月23日、20ccなど）
- **分岐の視覚的表示**（選択肢と分岐ルートを色分け）
- **テキストサイズ変更対応**（ブラウザの文字サイズ変更に追従）

### レイアウトの特徴

#### 自動幅調整
各ページ(`.page.text`)は内容量に応じて幅が自動調整されます:
- 短い段落 → 狭いページ
- 長い段落 → 広いページ
- テキストサイズを変更 → ページ幅も自動調整

これにより、余白が最小化され、読みやすい表示になります。

#### ページ間隔
- `gap: 0` - ページ間の基本間隔なし
- `padding: 0.5em` - 各ページの最小余白
- 結果: テキストサイズに関係なく、詰まった表示

### 数字の自動フォーマット

縦書き表示で数字を横向きに表示（縦中横）:
- 入力: `12月23日`
- 出力: `<span class="tcy">12</span>月<span class="tcy">23</span>日`
- 表示: 縦書きの中で数字だけが横向きに!

対応する単位: 年月日時分秒cc

## 注意事項

1. **Excelファイル名**: バッチ処理の場合は `main_数字_タイトル.xlsx` 形式を推奨
   - 例: `main_0_暗黒時代・上.xlsx`
   - 別のファイル名の場合は適宜調整してください

2. **AIの出力ファイル名**: `output/novel_output_main_X_タイトル.txt` に保存

3. **文字数制限**: AIによっては一度に処理できる文字数に制限があるので、その場合は分割処理

4. **--no-aiモード**: AI変換をスキップして直接HTML生成が可能
   - 会話形式をそのまま縦書きで表示
   - 話者名が上部に独立表示され、読みやすい

## 🔧 環境要件

- Python 3.8以上
- openpyxl
  ```bash
  pip install openpyxl
  ```

## トラブルシューティング

### Q: HTMLが生成されない（--no-aiモード）
A: `ai_input`ファイルが存在するか確認してください。バッチ処理なら一度通常モードで実行してください。

### Q: 話者名の表示がおかしい
A: `--no-ai`モードでは自動的に話者名が上に表示されます。通常のAI変換モードでは小説風に統合されます。

### Q: AIが台本形式で出力してしまう
A: `ai_prompt.txt` のプロンプトを使用してください。具体例を示しているので、小説風になります。

### Q: 画像が表示されない
A: URLが正しいか、インターネット接続を確認してください。

### Q: 選択肢の表示がおかしい
A: 最新版では以下の形式で表示されます:
   1. 全選択肢を一度に表示
   2. 各選択肢 + 対応する回答を個別ページで表示